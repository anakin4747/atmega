HEX = ./bin/flash_target.hex
BINARY = ./bin/bin
CODEDIRS = ./src
INCDIRS = . ./include/  # Can be a list
CC = avr-gcc
OPT = -Os
DEPFLAGS = -MP -MD
CFLAGS = -Wall -Wextra -g $(foreach D, $(INCDIRS), -I$(D)) $(OPT) $(DEPFLAGS) -DF_CPU=16000000UL -mmcu=atmega328p 
CFILES = $(foreach D, $(CODEDIRS), $(wildcard $(D)/*.c))
OBJECTS = $(patsubst %.c, %.o, $(CFILES))
DEPFILES = $(patsubst %.c, %.d, $(CFILES))


all: $(HEX)

$(HEX): $(BINARY)
	avr-objcopy -O ihex -R .eeprom $^ $@

$(BINARY): $(OBJECTS) 
	$(CC) -o $@ $^

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

clean:
	rm -rf $(OBJECTS) $(DEPFILES) dist.tgz

fullclean:
	rm -rf $(OBJECTS) $(DEPFILES) $(HEX) $(BINARY) dist.tgz
	
flash: 
	sudo avrdude -F -V -c arduino -p ATMEGA328P -P /dev/ttyUSB0 -b 115200 -U flash:w:$(HEX)

-include $(DEPFILES)
